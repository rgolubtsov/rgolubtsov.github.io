#!/usr/bin/env bash
# utils/html-emoji-preproc
# =============================================================================
# This helper script automates replacing emoji character sequences with their
# image representations.
#
# It searches for files in the current/specified directory (expected they are
# HTML docs generated by Harp from their Markdown counterparts) which contain
# emoji sequences, and replaces them with the HTML tag <img> referring
# to those emoji images stored on the GitHub Assets site.
# =============================================================================
# Copyright (C) 2019-2022 Radislav (Radicchio) Golubtsov
#
# (See the LICENSE file at the top of the source tree.)
#

# Helper constants.
declare -r EXIT_FAILURE=1 #    Failing exit status.
declare -r EXIT_SUCCESS=0 # Successful exit status.

declare -r REPL_URL="https\:\/\/github\.githubassets\.com\/images\/icons\/emoji\/unicode\/"
declare -r REPL_EXT="\.png"
declare -r REPL_CSS="emoji"

declare -r REPL_PREFIX="<img\ src=\"${REPL_URL}"
declare -r REPL_SUFFIX="${REPL_EXT}\"\ class=\"${REPL_CSS}\"\ alt=\"\"\ \/>"

declare -r EMOJI_CHARS=(
    +1
    blue_heart
    smiley
    raising_hand
)
declare -r EMOJI_CODES=(
    1f44d
    1f499
    1f603
    1f64b
)

DIR=.

if [ $# -ne 0 ]; then
    DIR=$1
fi

i=0

echo "=== Making emoji replacements with images against their character sequences."

for emoji in ${EMOJI_CHARS[@]}; do
    grep -Rl   ":${emoji}:" ${DIR} | xargs \
    sed  -i -e "s/\:${emoji}\:/${REPL_PREFIX}${EMOJI_CODES[i]}${REPL_SUFFIX}/g"

    let i++
done

# --- Debug output - Begin ----------------------------------------------------
# Searching for and printing out all the entries containing "emoji".
#echo; find ./data/ -type f | xargs grep "emoji"; echo
# --- Debug output - End ------------------------------------------------------

# If there is an error -- telling the OS about this.
if [ $? -eq ${EXIT_FAILURE} ]; then
    exit    ${EXIT_FAILURE}
fi

exit        ${EXIT_SUCCESS}

# vim:set nu et ts=4 sw=4:
